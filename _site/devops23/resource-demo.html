<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hands-On Time | vfarcic.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hands-On Time" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/devops23/resource-demo.html" />
<meta property="og:url" content="http://localhost:4000/devops23/resource-demo.html" />
<meta property="og:site_name" content="vfarcic.github.io" />
<script type="application/ld+json">
{"url":"http://localhost:4000/devops23/resource-demo.html","@type":"WebPage","headline":"Hands-On Time","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d7b0fccce7a840960ab2c608e690e524c171b2d9">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">vfarcic.github.io</a></h1>
      

      <h2 id="hands-on-time">Hands-On Time</h2>

<hr />

<h1 id="managing-resources">Managing Resources</h1>

<h2 id="enabling-heapster">Enabling Heapster</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
minikube addons <span class="nb">enable </span>heapster

<span class="c"># If EKS</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/heapster.yaml

<span class="c"># If EKS</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/influxdb.yaml

<span class="c"># If EKS</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/rbac/heapster-rbac.yaml

<span class="c"># GKE already has it pre-installed</span>
</code></pre></div></div>

<h2 id="enabling-heapster-1">Enabling Heapster</h2>

<hr />

<ul>
  <li>We installed Heapster and InfluxDB</li>
</ul>

<h2 id="memory-and-cpu-resources">Memory And CPU Resources</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>res/go-demo-2-random.yml

kubectl create <span class="nt">-f</span> res/go-demo-2-random.yml <span class="nt">--record</span> <span class="nt">--save-config</span>

kubectl rollout status deployment go-demo-2-api

kubectl describe deploy go-demo-2-api

kubectl describe nodes
</code></pre></div></div>

<h2 id="memory-and-cpu-resources-1">Memory And CPU Resources</h2>

<hr />

<ul>
  <li>We installed <em>go-demo-2</em> with randomly defined resource requests and limits</li>
  <li>We described the nodes and observed resource utilization</li>
</ul>

<h2 id="measuring-consumption">Measuring Consumption</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> kube-system get pods

<span class="c"># If minikube</span>
kubectl <span class="nt">-n</span> kube-system expose rc heapster <span class="se">\</span>
    <span class="nt">--name</span> heapster-api <span class="nt">--port</span> 8082 <span class="nt">--type</span> NodePort

<span class="c"># If EKS</span>
kubectl <span class="nt">-n</span> kube-system expose deployment heapster <span class="se">\</span>
    <span class="nt">--name</span> heapster-api <span class="nt">--port</span> 8082 <span class="nt">--type</span> LoadBalancer

<span class="c"># If GKE</span>
kubectl <span class="nt">-n</span> kube-system expose deployment heapster-v1.5.2 <span class="se">\</span>
    <span class="nt">--name</span> heapster-api <span class="nt">--port</span> 8082 <span class="nt">--type</span> LoadBalancer

kubectl <span class="nt">-n</span> kube-system get svc heapster-api <span class="nt">-o</span> json
</code></pre></div></div>

<h2 id="measuring-consumption-1">Measuring Consumption</h2>

<hr />

<ul>
  <li>We exposed Heapster API and confirmed that the service was created</li>
</ul>

<h2 id="measuring-consumption-2">Measuring Consumption</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># If minikube</span>
<span class="nv">PORT</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">-n</span> kube-system get svc heapster-api <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.spec.ports[0].nodePort}"</span><span class="k">)</span>

<span class="c"># If EKS or GKE</span>
<span class="nv">PORT</span><span class="o">=</span>8082

<span class="c"># If minikube</span>
<span class="nv">ADDR</span><span class="o">=</span><span class="k">$(</span>minikube ip<span class="k">)</span>

<span class="c"># If EKS</span>
<span class="nv">ADDR</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">-n</span> kube-system get svc heapster-api <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[0].hostname}"</span><span class="k">)</span>

<span class="c"># If GKE</span>
<span class="nv">ADDR</span><span class="o">=</span><span class="k">$(</span>kubectl <span class="nt">-n</span> kube-system get svc heapster-api <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.status.loadBalancer.ingress[0].ip}"</span><span class="k">)</span>
</code></pre></div></div>

<h2 id="measuring-consumption-3">Measuring Consumption</h2>

<hr />

<ul>
  <li>We retrieved Heapster’s address and the port</li>
</ul>

<h2 id="measuring-consumption-4">Measuring Consumption</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BASE_URL</span><span class="o">=</span><span class="s2">"http://</span><span class="nv">$ADDR</span><span class="s2">:</span><span class="nv">$PORT</span><span class="s2">/api/v1/model/namespaces/default/pods"</span>

curl <span class="s2">"</span><span class="nv">$BASE_URL</span><span class="s2">"</span>

<span class="nv">DB_POD_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl get pods <span class="nt">-l</span> <span class="nv">service</span><span class="o">=</span>go-demo-2 <span class="nt">-l</span> <span class="nb">type</span><span class="o">=</span>db <span class="se">\</span>
    <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[0].metadata.name}"</span><span class="k">)</span>

curl <span class="s2">"</span><span class="nv">$BASE_URL</span><span class="s2">/</span><span class="nv">$DB_POD_NAME</span><span class="s2">/containers/db/metrics"</span>

curl <span class="s2">"</span><span class="nv">$BASE_URL</span><span class="s2">/</span><span class="nv">$DB_POD_NAME</span><span class="s2">/containers/db/metrics/memory/usage"</span>

curl <span class="s2">"</span><span class="nv">$BASE_URL</span><span class="s2">/</span><span class="nv">$DB_POD_NAME</span><span class="s2">/containers/db/metrics/cpu/usage_rate"</span>
</code></pre></div></div>

<h2 id="measuring-consumption-5">Measuring Consumption</h2>

<hr />

<ul>
  <li>We generated a base URL for requests to Heapster</li>
  <li>We retrieved from Heapster the Pods from the default Namespace</li>
  <li>We retrieved the name of the DB Pod</li>
  <li>We retrieved the list of the available metrics</li>
  <li>We retrieved DBs memory (~33MB) and CPU (~0.002) usage</li>
</ul>

<h2 id="resource-discrepancies">Resource Discrepancies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>res/go-demo-2-insuf-mem.yml

kubectl apply <span class="nt">-f</span> res/go-demo-2-insuf-mem.yml <span class="nt">--record</span>

kubectl get pods

kubectl describe pod go-demo-2-db

<span class="nb">cat </span>res/go-demo-2-insuf-node.yml

kubectl apply <span class="nt">-f</span> res/go-demo-2-insuf-node.yml <span class="nt">--record</span>

kubectl get pods

kubectl describe pod go-demo-2-db
</code></pre></div></div>

<h2 id="resource-discrepancies-1">Resource Discrepancies</h2>

<hr />

<ul>
  <li>We updated the DB by setting insufficient memory</li>
  <li>We retrieved the Pods and observed that the status of the DB is <code class="highlighter-rouge">OOMKilled</code></li>
  <li>We described DB Deployment and observed that the <code class="highlighter-rouge">Last State</code> is <code class="highlighter-rouge">Terminated</code> for <code class="highlighter-rouge">OOMKilled</code> reason</li>
  <li>We updated the DB by setting more memory than the size of VMs</li>
  <li>We retrieved the Pods and observed that the status of the DB is <code class="highlighter-rouge">Pending</code></li>
  <li>We described DB Pod and observed that there are no nodes available due to insufficient memory</li>
</ul>

<h2 id="resource-discrepancies-2">Resource Discrepancies</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> res/go-demo-2-random.yml <span class="nt">--record</span>

kubectl rollout status deployment go-demo-2-db

kubectl rollout status deployment go-demo-2-api
</code></pre></div></div>

<h2 id="resource-discrepancies-3">Resource Discrepancies</h2>

<hr />

<ul>
  <li>We updated the application back to the definition that worked</li>
</ul>

<h2 id="adjusting-resources">Adjusting Resources</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DB_POD_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl get pods <span class="nt">-l</span> <span class="nv">service</span><span class="o">=</span>go-demo-2 <span class="se">\</span>
    <span class="nt">-l</span> <span class="nb">type</span><span class="o">=</span>db <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[0].metadata.name}"</span><span class="k">)</span>

curl <span class="s2">"</span><span class="nv">$BASE_URL</span><span class="s2">/</span><span class="nv">$DB_POD_NAME</span><span class="s2">/containers/db/metrics/memory/usage"</span>

curl <span class="s2">"</span><span class="nv">$BASE_URL</span><span class="s2">/</span><span class="nv">$DB_POD_NAME</span><span class="s2">/containers/db/metrics/cpu/usage_rate"</span>

<span class="nv">API_POD_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl get pods <span class="nt">-l</span> <span class="nv">service</span><span class="o">=</span>go-demo-2 <span class="se">\</span>
    <span class="nt">-l</span> <span class="nb">type</span><span class="o">=</span>api <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.items[0].metadata.name}"</span><span class="k">)</span>

curl <span class="s2">"</span><span class="nv">$BASE_URL</span><span class="s2">/</span><span class="nv">$API_POD_NAME</span><span class="s2">/containers/api/metrics/memory/usage"</span>

curl <span class="s2">"</span><span class="nv">$BASE_URL</span><span class="s2">/</span><span class="nv">$API_POD_NAME</span><span class="s2">/containers/api/metrics/cpu/usage_rate"</span>
</code></pre></div></div>

<h2 id="adjusting-resources-1">Adjusting Resources</h2>

<hr />

<ul>
  <li>We retrieved memory and CPU usage of the DB and the API Pods</li>
</ul>

<h2 id="adjusting-resources-2">Adjusting Resources</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>res/go-demo-2.yml

kubectl apply <span class="nt">-f</span> res/go-demo-2.yml <span class="nt">--record</span>

kubectl rollout status deployment go-demo-2-api
</code></pre></div></div>

<h2 id="adjusting-resources-3">Adjusting Resources</h2>

<hr />

<ul>
  <li>We updated the definitions so that memory and CPU usage and limits reflect the actual usage</li>
</ul>

<h2 id="quality-of-service-qos">Quality Of Service (QoS)</h2>

<hr />

<h2 id="guaranteed-qos">Guaranteed QoS</h2>

<hr />

<ul>
  <li>Both memory and CPU limits must be set.</li>
  <li>Memory and CPU requests must be set to the same values as the limits, or they can be left empty, in which case they default to the limits (we’ll explore them soon).</li>
  <li>Pods with Guaranteed QoS assigned are the top priority and will never be killed unless they exceed their limits or are unhealthy.</li>
</ul>

<h2 id="burstable-qos">Burstable QoS</h2>

<hr />

<ul>
  <li>Assigned to Pods that do not meet the criteria for Guaranteed QoS but have at least one container with memory or CPU requests defined.</li>
  <li>Guaranteed minimal (requested) memory usage.</li>
</ul>

<h2 id="besteffort-qos">BestEffort QoS</h2>

<hr />

<ul>
  <li>Pods that do not qualify as Guaranteed or Burstable.</li>
  <li>Consist of containers that have none of the resources defined.</li>
  <li>Can use any available memory they need.</li>
  <li>When in need of more resources, Kubernetes will start killing containers residing in the Pods with BestEffort QoS.</li>
</ul>

<h2 id="quality-of-service-qos-1">Quality Of Service (QoS)</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe pod go-demo-2-db

<span class="nb">cat </span>res/go-demo-2-qos.yml

kubectl apply <span class="nt">-f</span> res/go-demo-2-qos.yml <span class="nt">--record</span>

kubectl rollout status deployment go-demo-2-db

kubectl describe pod go-demo-2-db

kubectl describe pod go-demo-2-api

kubectl delete <span class="nt">-f</span> res/go-demo-2-qos.yml
</code></pre></div></div>

<h2 id="quality-of-service-qos-2">Quality Of Service (QoS)</h2>

<hr />

<ul>
  <li>We described DB Pod and observed observed that the QoS is <code class="highlighter-rouge">Burstable</code></li>
  <li>We updated the DB to have the same values for <code class="highlighter-rouge">requests</code> and <code class="highlighter-rouge">limits</code></li>
  <li>We updated the API by removing the <code class="highlighter-rouge">requests</code> and <code class="highlighter-rouge">limits</code></li>
  <li>We described the DB Pod and observed that the QoS is <code class="highlighter-rouge">Guaranteed</code></li>
  <li>We described the API Pod and observed that the QoS is <code class="highlighter-rouge">BestEffort</code></li>
  <li>We deleted the applicaation</li>
</ul>

<h2 id="defaults-and-limitations">Defaults and Limitations</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create namespace <span class="nb">test

cat </span>res/limit-range.yml

kubectl <span class="nt">-n</span> <span class="nb">test </span>create <span class="nt">-f</span> res/limit-range.yml <span class="se">\</span>
    <span class="nt">--save-config</span> <span class="nt">--record</span>

kubectl describe namespace <span class="nb">test

cat </span>res/go-demo-2-no-res.yml

kubectl <span class="nt">-n</span> <span class="nb">test </span>create <span class="nt">-f</span> res/go-demo-2-no-res.yml <span class="se">\</span>
    <span class="nt">--save-config</span> <span class="nt">--record</span>

kubectl <span class="nt">-n</span> <span class="nb">test </span>rollout status deployment go-demo-2-api
</code></pre></div></div>

<h2 id="defaults-and-limitations-1">Defaults and Limitations</h2>

<hr />

<ul>
  <li>We created the <code class="highlighter-rouge">test</code> Namespace with <code class="highlighter-rouge">LimitRange</code></li>
  <li>We described the Namespace and observed the limits</li>
  <li>We installed the application without resources</li>
</ul>

<h2 id="defaults-and-limitations-2">Defaults and Limitations</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> <span class="nb">test </span>describe pod go-demo-2-db

<span class="nb">cat </span>res/go-demo-2.yml

kubectl <span class="nt">-n</span> <span class="nb">test </span>apply <span class="nt">-f</span> res/go-demo-2.yml <span class="nt">--record</span>

kubectl <span class="nt">-n</span> <span class="nb">test </span>get events <span class="nt">-w</span>

kubectl <span class="nt">-n</span> <span class="nb">test </span>run <span class="nb">test</span> <span class="nt">--image</span> alpine <span class="nt">--requests</span> <span class="nv">memory</span><span class="o">=</span>100Mi <span class="se">\</span>
    <span class="nt">--restart</span> Never sleep 10000

kubectl <span class="nt">-n</span> <span class="nb">test </span>run <span class="nb">test</span> <span class="nt">--image</span> alpine <span class="nt">--requests</span> <span class="nv">memory</span><span class="o">=</span>1Mi <span class="se">\</span>
    <span class="nt">--restart</span> Never sleep 10000

kubectl delete namespace <span class="nb">test</span>
</code></pre></div></div>

<h2 id="defaults-and-limitations-3">Defaults and Limitations</h2>

<hr />

<ul>
  <li>We described the DB Pod and observed that it was assigned default limits and requests</li>
  <li>We updated DB by setting memory above the limit and the API by setting memory below the limit</li>
  <li>We observed that creating the API is forbidden because its memory is below the limit and that the DB is forbidden because its memory is above the limit</li>
  <li>We failed to create a new Pod because the requested memory is above the limit</li>
  <li>We failed to create a new Pod because the requested memory is below the limit</li>
  <li>We deleted the <code class="highlighter-rouge">test</code> Namespace</li>
</ul>

<h2 id="resource-quotas">Resource Quotas</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>res/dev.yml

kubectl create <span class="nt">-f</span> res/dev.yml <span class="nt">--record</span> <span class="nt">--save-config</span>

kubectl <span class="nt">-n</span> dev describe quota dev

kubectl <span class="nt">-n</span> dev create <span class="nt">-f</span> res/go-demo-2.yml <span class="nt">--save-config</span> <span class="nt">--record</span>

kubectl <span class="nt">-n</span> dev rollout status deployment go-demo-2-api

kubectl <span class="nt">-n</span> dev describe quota dev
</code></pre></div></div>

<h2 id="resource-quotas-1">Resource Quotas</h2>

<hr />

<ul>
  <li>We created the <code class="highlighter-rouge">dev</code> Namespace with <code class="highlighter-rouge">ResourceQuota</code></li>
  <li>We installed the applicatiton</li>
  <li>We described the <code class="highlighter-rouge">quota</code> and observed <code class="highlighter-rouge">Used</code> and <code class="highlighter-rouge">Hard</code> values</li>
</ul>

<h2 id="resource-quotas-2">Resource Quotas</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>res/go-demo-2-scaled.yml

kubectl <span class="nt">-n</span> dev apply <span class="nt">-f</span> res/go-demo-2-scaled.yml <span class="nt">--record</span>

kubectl <span class="nt">-n</span> dev get events

kubectl describe namespace dev

kubectl get pods <span class="nt">-n</span> dev

kubectl <span class="nt">-n</span> dev apply <span class="nt">-f</span> res/go-demo-2.yml <span class="nt">--record</span>

kubectl <span class="nt">-n</span> dev rollout status deployment go-demo-2-api
</code></pre></div></div>

<h2 id="resource-quotas-3">Resource Quotas</h2>

<hr />

<ul>
  <li>We updated the application by increasing the number of API replicas to <code class="highlighter-rouge">15</code>.</li>
  <li>We retrieved the events and observed that creating of some Pods was forbidden due to CPU and Pods limits</li>
  <li>We described the <code class="highlighter-rouge">dev</code> Namespace and observed that we reached the quota for CPU and Pods</li>
  <li>We retrieved the Pods and observed that some are missing</li>
  <li>We updated the application to the previous working version</li>
</ul>

<h2 id="resource-quotas-4">Resource Quotas</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>res/go-demo-2-mem.yml

kubectl <span class="nt">-n</span> dev apply <span class="nt">-f</span> res/go-demo-2-mem.yml <span class="nt">--record</span>

kubectl <span class="nt">-n</span> dev get events | <span class="nb">grep </span>mem

kubectl describe namespace dev

kubectl <span class="nt">-n</span> dev apply <span class="nt">-f</span> res/go-demo-2.yml <span class="nt">--record</span>

kubectl <span class="nt">-n</span> dev rollout status deployment go-demo-2-api

kubectl expose deployment go-demo-2-api <span class="nt">-n</span> dev <span class="se">\</span>
    <span class="nt">--name</span> go-demo-2-api <span class="nt">--port</span> 8080 <span class="nt">--type</span> NodePort
</code></pre></div></div>

<h2 id="resource-quotas-5">Resource Quotas</h2>

<hr />

<ul>
  <li>We increased the memory of the API Pods</li>
  <li>We retrieved the events and observed that creation of some Pods was forbidden</li>
  <li>We described the <code class="highlighter-rouge">dev</code> Namespace and observed that we used almost all the memory quota</li>
  <li>We updated the application to the last known working version</li>
  <li>We failed to expose a <code class="highlighter-rouge">NodePort</code></li>
</ul>

<h2 id="what-now">What Now?</h2>

<hr />

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete ns dev
</code></pre></div></div>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="https://github.com/vfarcic/vfarcic.github.io/edit/gh-pages/devops23/resource-demo.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
